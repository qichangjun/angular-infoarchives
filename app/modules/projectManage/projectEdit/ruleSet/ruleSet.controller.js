// Generated by CoffeeScript 1.9.1
(function() {
  'use strict';
  angular.module("myApp").controller("ruleSetController", [
    '$scope', '$log', '$state', 'projectManageService', 'mdDialogService', '$timeout', '$mdToast', '$stateParams', 'ruleSetService', 'dataModuleService', function($scope, $log, $state, projectManageService, mdDialogService, $timeout, $mdToast, $stateParams, ruleSetService, dataModuleService) {
      var addRule, changeAttr, deleteRule, getProperty, getRetentionPeriodId, getRetentionPeriodList, getRule, getVersionList, init, saveRetentionPeriod, saveRule, serfToCreateModule, showAdd, showEdit, vm;
      vm = this;
      vm.parameter = $stateParams;
      vm.entity = {
        fieldType: 0
      };
      vm.ruleProperty = [];
      init = function() {
        getRule();
        getProperty();
        getVersionList();
        getRetentionPeriodList();
        getRetentionPeriodId();
      };
      getRetentionPeriodId = function() {
        return ruleSetService.getRetentionPeriodId(vm.parameter.objectId).then(function(res) {
          if (res && res.id) {
            return vm.retentionPeriod = res.id;
          } else {
            return vm.retentionPeriod = null;
          }
        }, function(res) {});
      };
      getRetentionPeriodList = function() {
        return ruleSetService.getRetentionPeriodList().then(function(res) {
          return vm.retentionPeriodList = res;
        }, function(res) {});
      };
      getVersionList = function() {
        vm.afterLoad = false;
        return dataModuleService.getModuleVersionList(vm.parameter.objectId).then(function(res) {
          vm.afterLoad = true;
          return vm.versionList = res;
        }, function(res) {
          vm.afterLoad = true;
        });
      };
      getRule = function() {
        return ruleSetService.getRule(vm.parameter.objectId).then(function(res) {
          vm.ruleProperty = res.fields;
          vm.codingPolicy = res.codingPolicy;
          if (vm.ruleProperty.length === 0) {
            vm.createRule = true;
          } else {
            vm.createRule = false;
          }
        }, function(res) {});
      };
      getProperty = function() {
        return ruleSetService.getProperty(vm.parameter.objectId).then(function(res) {
          return vm.ruleType = res;
        }, function(res) {});
      };
      serfToCreateModule = function() {
        return $state.go('infoArchives.projectEdit.dataModule', {
          objectId: vm.parameter.objectId,
          create: true
        });
      };
      showAdd = function(e) {
        var i, j, len, ref, rows;
        e.stopPropagation();
        ref = vm.ruleProperty;
        for (i = j = 0, len = ref.length; j < len; i = ++j) {
          rows = ref[i];
          rows.showEdit = false;
        }
        return vm.showLastAdd = true;
      };
      deleteRule = function(index) {
        return vm.ruleProperty.splice(index, 1);
      };
      saveRule = function() {
        saveRetentionPeriod();
        if (!vm.createRule) {
          return ruleSetService.saveRule(vm.ruleProperty, vm.codingPolicy).then(function(res) {}, function(res) {
            return console.log(vm.ruleProperty);
          });
        } else {
          return ruleSetService.createRule(vm.ruleProperty, vm.parameter.objectId).then(function(res) {
            vm.codingPolicy = res.codingPolicy;
            vm.ruleProperty = res.fields;
            vm.createRule = false;
          }, function(res) {
            return console.log(vm.ruleProperty);
          });
        }
      };
      saveRetentionPeriod = function() {
        return ruleSetService.saveRetentionPeriod(vm.retentionPeriod, vm.parameter.objectId).then(function(res) {
          return getRetentionPeriodId();
        }, function(res) {});
      };
      showEdit = function(e, index) {
        var i, j, len, ref, rows;
        e.stopPropagation();
        ref = vm.ruleProperty;
        for (i = j = 0, len = ref.length; j < len; i = ++j) {
          rows = ref[i];
          rows.showEdit = false;
        }
        vm.showLastAdd = false;
        return vm.ruleProperty[index].showEdit = true;
      };
      changeAttr = function(index) {
        var i, j, len, ref, results, rows;
        ref = vm.ruleType;
        results = [];
        for (i = j = 0, len = ref.length; j < len; i = ++j) {
          rows = ref[i];
          if (angular.isUndefined(index) && (rows.attrName === vm.entity.attrName)) {
            vm.entity.attrDisplayName = rows.displayName;
            break;
          } else if ((index >= 0) && (rows.attrName === vm.ruleProperty[index].attrName)) {
            vm.ruleProperty[index].attrDisplayName = rows.displayName;
            break;
          } else {
            results.push(void 0);
          }
        }
        return results;
      };
      addRule = function(info) {
        if (info.fieldType >= 0) {
          vm.ruleProperty.push(info);
          vm.entity = {
            fieldType: 0
          };
          return vm.showLastAdd = false;
        }
      };
      vm.addRule = addRule;
      vm.changeAttr = changeAttr;
      vm.showEdit = showEdit;
      vm.saveRule = saveRule;
      vm.deleteRule = deleteRule;
      vm.showAdd = showAdd;
      vm.serfToCreateModule = serfToCreateModule;
      init();
    }
  ]);

}).call(this);

//# sourceMappingURL=ruleSet.controller.js.map

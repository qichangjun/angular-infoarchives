// Generated by CoffeeScript 1.9.1
(function() {
  'use strict';
  angular.module("myApp").filter("toDate", function() {
    return function(input) {
      if (input) {
        return new Date(input);
      } else {
        return null;
      }
    };
  }).controller("dataErrorController", [
    '$scope', '$log', '$state', '$timeout', '$element', '$stateParams', 'dataErrorService', 'dataBaseService', 'hsUiGridTemplates', 'i18nService', 'hsTpl', function($scope, $log, $state, $timeout, $element, $stateParams, dataErrorService, dataBaseService, hsUiGridTemplates, i18nService, hsTpl) {
      var getBaseData, getDataDown, getDataList, getGridData, init, initGrid, loadDataType, loadSystemSource, loadUnit, reset, search, vm;
      vm = this;
      vm.systemSource;
      vm.unit;
      vm.dataType;
      vm.parameter = $stateParams;
      init = function() {
        initGrid();
        loadSystemSource();
        loadUnit();
        loadDataType();
        getDataList();
      };
      initGrid = function() {
        i18nService.setCurrentLang('zh-cn');
        return $scope.gridOptions = {
          infiniteScrollRowsFromEnd: 30,
          infiniteScrollDown: true,
          rowTemplate: hsTpl.hsRowTemplate,
          rowHeight: 40,
          saveSort: false,
          selectionRowHeaderWidth: 29,
          enableGridMenu: true,
          enablePaginationControls: true,
          enableRowSelection: true,
          enableSelectAll: true,
          useExternalSorting: true,
          onRegisterApi: function(gridApi) {
            gridApi.infiniteScroll.on.needLoadMoreData($scope, getDataDown);
            $scope.gridApi = gridApi;
            $scope.gridApi.core.on.sortChanged($scope, function(grid, sortColumns) {
              if (sortColumns.length === 0) {
                return vm.parameter.sortWay = null;
              } else {
                vm.parameter.sortWay = sortColumns[0].sort.direction.toLocaleUpperCase();
                return vm.parameter.sortField = sortColumns[0].name;
              }
            });
            return $scope.cancelSelect = function(row) {
              if (gridApi.selection) {
                if (gridApi.selection.getSelectedRows().length === 1 && gridApi.selection.getSelectedRows()[0] === row) {
                  gridApi.selection.clearSelectedRows();
                } else if (gridApi.selection.getSelectedRows().length === 1 && gridApi.selection.getSelectedRows()[0] !== row) {
                  gridApi.selection.clearSelectedRows();
                  gridApi.selection.selectRow(row);
                } else if (gridApi.selection.getSelectedRows().length < 1) {
                  gridApi.selection.selectRow(row);
                } else if (gridApi.selection.getSelectedRows().length > 1) {
                  gridApi.selection.clearSelectedRows();
                  gridApi.selection.selectRow(row);
                }
              }
            };
          }
        };
      };
      getDataDown = function() {
        if (vm.parameter.objectId) {
          return dataBaseService.getGridData(vm.parameter).then(function(res) {
            $scope.gridApi.infiniteScroll.saveScrollPercentage();
            $scope.gridOptions.data = $scope.gridOptions.data.concat(res.data);
            return $scope.gridApi.infiniteScroll.dataLoaded(true, true).then(function() {});
          }, function(res) {});
        }
      };
      getDataList = function() {
        return dataBaseService.getDataList().then(function(res) {
          vm.dataBases = res.data;
          vm.parameter.objectId = res.data[0].objectId;
          $state.go('.', vm.parameter, {
            notify: false
          });
          return getBaseData(res.data[0].objectId);
        }, function(res) {});
      };
      getBaseData = function(id) {
        vm.parameter.objectId = id;
        $state.go('.', vm.parameter, {
          notify: false
        });
        return getGridData();
      };
      getGridData = function() {
        vm.loading = true;
        if (vm.parameter.objectId) {
          return dataBaseService.getGridData(vm.parameter).then(function(res) {
            var column, i, len, ref, results;
            vm.loading = false;
            $scope.gridOptions.data = res.data;
            $scope.gridOptions.totalItems = 200;
            $scope.gridOptions.columnDefs = hsUiGridTemplates.dataBase;
            $scope.gridOptions.columnVirtualizationThreshold = hsUiGridTemplates.dataBase.length;
            ref = $scope.gridOptions.columnDefs;
            results = [];
            for (i = 0, len = ref.length; i < len; i++) {
              column = ref[i];
              results.push(column.enableColumnMenu = false);
            }
            return results;
          }, function(res) {});
        }
      };
      loadSystemSource = function() {
        return dataErrorService.getSystemSource().then(function(res) {
          return vm.systemSourceLists = res.data;
        }, function(res) {});
      };
      loadUnit = function() {
        return dataErrorService.getUnit().then(function(res) {
          return vm.unitList = res.data;
        }, function(res) {});
      };
      loadDataType = function() {
        return dataErrorService.getDataType().then(function(res) {
          return vm.dataTypeList = res.data;
        }, function(res) {});
      };
      search = function() {
        return $state.go('.', vm.parameter, {
          notify: false
        });
      };
      reset = function(info) {
        return info = null;
      };
      vm.getBaseData = getBaseData;
      vm.reset = reset;
      vm.search = search;
      vm.loadDataType = loadDataType;
      vm.loadUnit = loadUnit;
      vm.loadSystemSource = loadSystemSource;
      init();
    }
  ]);

}).call(this);

//# sourceMappingURL=dataError.controller.js.map
